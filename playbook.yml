---
#- hosts: localhost
#  name: prepare system for reinstall
#  become: yes
#  connection: local
#  tags: ['backup', 'bootable']
#
#  roles:
#    - role: 'backup'
#    - role: 'bootable'

- hosts: localhost
  name: bootstrap ArchLinux system
  become: yes
  connection: local
  tags: ['bootstrap']

  # pre_tasks:
  #   - include_vars: "group_vars/disks.yml"
  #     when: '"disk_schema" is not defined'

  roles:
    - role: 'uefi'
    - role: 'part'
      vars: { mode: 'disk' }
    - role: 'luks'
    - role: 'lvm'
    - role: 'part'
      vars: { mode: 'luks' }
      when: 'nolvm == True'
    - role: 'fsmnt'
    - role: 'packages'
      vars: { modes: [ 'boot' ] }
    - role: 'blobs'

- hosts: chroot
  name: install Archlinux
  connection: chroot
  tags: ['install']

  # pre_tasks:
  #   - include_vars: "group_vars/disks.yml"
  #     when: '"disk_schema" is not defined'

  roles:
    - role: 'locale'
    - role: 'hosts'
    - role: 'packages'
      vars: { modes: [ 'min', 'typ', 'aur' ] }
    - role: 'apps'
    - role: 'plymouth'
    - role: 'boot'
    - role: 'secureboot'
      when: 'hostname not in [ "default", "nocrypt" ]' # dont run secureboot on VMs
    - role: 'accounts'
    - role: 'folders' # /home/aryan and /life
      vars: { mode: 'root' }

- hosts: chroot
  name: user setup
  become: true
  become_method: sudo
  connection: chroot
  become_user: "{{ user.name }}"
  tags: ['user']

  roles:
    - role: 'dotfile'
    - role: 'folders'
      vars: { mode: "{{ user.name }}" }
    - role: 'user'
